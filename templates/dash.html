<!DOCTYPE html>
<html lang="en">
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Dashboard</title>
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
            integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
            crossorigin=""
    />
    <link
            href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css')}}"/>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.2/Chart.min.js"></script>
</head>
<body>
<header>
    <div class="inner">
        <h1>Soccer - Performance and Money</h1>
    </div>
</header>
<div class="container">
    <div class="side-wrapper">
        <div class="sidebar">
            <h2>Dashboard</h2>
            <div class="filters">
                <h4>League</h4>
                <select class="dd-country" id="selDataset" onchange="optionChanged()">
                    <option selected>All</option>
                </select>
                <h4>Club</h4>
                <select class="dd-country" id="selDataset1" onchange="optionChanged()">
                    <option selected>All</option>
                </select>
            </div>
        </div>
        <div class="sidebar">
            <div class="summary">
                <h2>Team Summary</h2>
                <h4>Market Value</h4>
                <p id="value"></p>
                <h4>Total Points</h4>
                <p id="points"></p>
                <h4>Average Points per Game</h4>
                <p id="ptspergame"></p>
                <h4>Matches Played</h4>
                <p id="matches"></p>
                <h4>Games Won</h4>
                <p id="won"></p>
                <h4>Games Drawn</h4>
                <p id="drawn"></p>
                <h4>Games Lost</h4>
                <p id="lost"></p>
            </div>
        </div>
    </div>
    <main>
        <div class="chart-box">
            <div id="bubble"></div>
            <canvas id="myChart" style="width: 100%; max-height: 100px"></canvas>
          
        </div>
        <div class="map-bar-box">
            <div class="map-box">
                <div id="map" style="width: 100%; height: 300px"></div>
            </div>
            <div class="bar-box">
                <canvas id="canvas" style="width: 100%; height: 300px"></canvas>
            </div>
        </div>
    </main>
</div>
</div>
<script
        src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""
></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>




//     //creating dropdown lists
//     //League filter
   
    let selector = d3.select("#selDataset");
    d3.json('/allleagues').then(data => {        
        data.forEach(sample => {                   
            selector
                .append('option')
                .text(sample)
                .property('value', sample);            
            let sampleleague = sample;         
        });
    });



    let selector1 = d3.select("#selDataset1")
    function selectorClub(countryName) {
        selector1.selectAll('option').empty();
        d3.json('/alldata').then(data => {
            let clubList = data.filter(sample => sample.country === countryName);
            clubName = clubList.map(d => d.club);
            clubName.forEach(sample => {
                selector1
                    .append('option')
                    .text(sample)
                    .property('value', sample);
            });
        });
    };

     

    function optionChanged() {
        let leaguedata = document.getElementById("selDataset").value;
        if (leaguedata !== 'All') {
            d3.json('/alldata').then(data => {
                let filtered = data.filter(sample => sample.country === leaguedata);
                bubbleChart(filtered);                
            })
            d3.json('/allleagues').then(data => {
                countryName = data.filter(sample => sample === leaguedata)[0];
                selectorClub(countryName);
                sideMenu(countryName)
            })
        }
        if (leaguedata == 'All') {
            d3.json('/alldata').then(data => {
                let allcountries = data;               
                bubbleAll(allcountries);
            });
        };
    };



    // Creating the side menu
    function sideMenu(countryName) {
        d3.json('./alldata').then(data => {
            
        })

    }



    function bubbleChart(filtered) {
        let x = filtered.map(a => a.pts_per_match);
        let y = filtered.map(a => Number((a.w)/(a.l)).toFixed(2));
        let text = filtered.map(a => a.club + '<br>Market Value: ' + a.market_value);
        let size = filtered.map(a => (a.market_value)/5000000);       
        let data = [{
            x: x,
            y: y,
            mode: 'markers',
            marker: {
                size: size,
            },
            text: text
        }];
        let layout = {
            title: 'Bubble Chart: Value and Performance',
            xaxis: {
                title: 'Average Points Won per Match'
            },
            yaxis: {
                title: 'Win:Loss Ratio'
            }
        };
        let config = {
            responsive: true
        };     
        Plotly.newPlot('bubble', data, layout, config);
    };     



        function bubbleAll(allcountries) {
        let leagues = [...new Set(allcountries.map(a => a.league))]; //create a SET of leagues and then convert it to a list by using '[...]'
        let colors = ["#cd6155", "#9b59b6", "#5dade2", "#48c9b0", "#f4d03f", "#8f39c12", "#85c1e9", "#aab7b8", "#d7bde2", "#935116", "#e6b0aa"];
        let x = allcountries.map(a => a.pts_per_match);        
        let y = allcountries.map(a => Number((a.w)/(a.l)).toFixed(2));
        let text = allcountries.map(a => a.club + '<br>Market Value: ' + a.market_value);
        let size = allcountries.map(a => (a.market_value)/5000000);       
        let data = [{
            x: x,
            y: y,
            mode: 'markers',
            marker: {
                size: size,
                color: allcountries.map(a => colors[leagues.indexOf(a.league)]) //get the index of a.league from the list 'leagues' and return the corresponding colors from the 'colors' list
            },
            text: text
        }];
        let layout = {
            title: 'Bubble Chart: Value and Performance',
            xaxis: {
                title: 'Average Points Won per Match'
            },
            yaxis: {
                title: 'Win:Loss Ratio'
            },
            showlegend: true
        };
        let config = {
            responsive: true
        };        
        Plotly.newPlot('bubble', data, layout, config);
    };



//     //creating a leaflet map
//     var defaultMap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
//         maxZoom: 19,
//         attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
//     });

//     let basemaps = {
//         'Default': defaultMap
//     };

//     var myMap = L.map("map", {
//         center: [40.41921, 3.69252],
//         zoom: 1.1,
//         layers: [defaultMap]
//     });

//     defaultMap.addTo(myMap);
//     let layoffs = new L.LayerGroup();


//     //adding the data layer to the map
//     function createMap(filteredGeo) {

//         layoffs.clearLayers();

//         function dataColor(Laid_Off_Count) {
//             if (Laid_Off_Count > 800)
//                 return "red";
//             else if (Laid_Off_Count > 300)
//                 return "#fc4903";
//             else if (Laid_Off_Count > 150)
//                 return "#fc8403";
//             else if (Laid_Off_Count > 80)
//                 return "#fcad03";
//             else if (Laid_Off_Count > 30)
//                 return "#cafc03";
//             else
//                 return "green";
//         }

//         function dataStyle(features) {
//             return {
//                 opacity: 0.5,
//                 fillOpacity: 0.5,
//                 fillColor: dataColor(features.properties.Laid_Off_Count), // use index 2 for the depth
//                 color: "000000", // black outline
//                 radius: 10, // grabs the magnitude
//                 weight: 0.5,
//                 stroke: true
//             }
//         }

//         L.geoJson(filteredGeo, {
//             pointToLayer: function (features, latLng) {
//                 return L.circleMarker(latLng);
//             },
//             style: dataStyle,
//             onEachFeature: function (features, layer) {
//                 layer.bindPopup(`Company: <b>${features.properties.Company}</b><br>
//                                   City: <b>${features.properties.City}</b><br>
//                                   Laid off Count: <b>${features.properties.Laid_Off_Count}</b>`);
//             }
//         }).addTo(layoffs);
//         layoffs.addTo(myMap);
//     };

    //creating the line chart
    // function createLn(geoFiltered) {
    //     var labeldata = [];
    //     var chrtdata = [];
    //     for (var i = 0; i < geoFiltered.length; i++) {
    //         //group by Date and set the laid off count
    //         let date = geoFiltered[i].properties.Date;
    //         let count = geoFiltered[i].properties.Laid_Off_Count;
    //         if (labeldata.includes(date)) {
    //             let index = labeldata.indexOf(date);
    //             chrtdata[index] += count;
    //         } else {
    //             labeldata.push(date);
    //             chrtdata.push(count);
    //         }
    //     }

    //     labeldata = labeldata.reverse();
    //     var ctx = document.getElementById("myChart").getContext("2d");
    //     var myChart = new Chart(ctx, {
    //         type: 'line',
    //         data: {
    //             labels: labeldata,
    //             datasets: [{
    //                 label: 'Layoffs',
    //                 data: chrtdata,
    //                 backgroundColor: "rgba(170,211,223,0.6)",
    //                 borderColor: "rgba(170,211,223,0.7)",
    //                 pointBorderColor: "rgba(170,211,223)",
    //                 pointBackgroundColor: "rgba(170,211,223)",
    //                 fillColor: "rgba(170,211,223,0.6)",
    //                 fill: true,

    //             }]
    //         }
    //     });
    // };

//     //using groupby to find the sum of layoffs for each filter
//     function groupBy(arr) {
//         var helper = {};
//         var result = arr.reduce(function (r, o) {
//             var key = o.properties.Date;

//             if (!helper[key]) {
//                 helper[key] = Object.assign({}, o);
//                 r.push(helper[key]);
//             } else {
//                 helper[key].properties.Laid_Off_Count += o.properties.Laid_Off_Count;
//             }
//             return r;
//         }, []);
//     };

//     //creating the bar chart
//     d3.json('/dataset/barchart').then((data) => {
//         var barlabeldata = [];
//         var bardata = [];
//         for (var i = 0; i < data.length; i++) {
//             barlabeldata.push(data[i].Industry);
//             bardata.push(data[i].Count)
//         }

//         var chr = document.getElementById("canvas").getContext("2d");

//         var barchart = new Chart(chr, {
//             type: 'bar',
//             data: {
//                 labels: barlabeldata,
//                 datasets: [
//                     {
//                         label: 'Layoffs by Industry',
//                         fillColor: "rgba(170,211,223,0.7)",
//                         strokeColor: "rgba(170,211,223)",
//                         backgroundColor: "rgba(170,211,223,0.6)",
//                         data: bardata,
//                     }
//                 ]
//             }
//         });
//     });

//     //plotting the whole dataset when we load the page
//     function init() {
//         optionDataFilter('All');
//     };

//     init();
</script>
</body>
</html>